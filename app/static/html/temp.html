<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en"><!--<![endif]-->
<head>
    <meta charset="utf-8">
    <title>Try Catch 原理剖析 - 王中周的技术博客</title>
    <meta name="author" content="王中周">


    <meta name="description"
          content="一、非局部跳转 1、简介 大部分语言的运行控制模型，都是基于栈的。在这种模型中，调用一个函数时，就会将这个函数的参数、返回地址、局部变量等信息入栈；这个函数返回时，对应信息再出栈。正常情况下，函数调用的进栈和出栈都是成对出现的，比如函数的调用顺序是：func1 &mdash;> func2 & &hellip;">
    <meta name="keywords" content="Objective-C, iOS,setjmp,longjmp,异常处理,try,catch">

    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link rel="canonical" href="http://foggry.com/blog/2018/11/15/try-catch-yuan-li-pou-xi">
    <link href="/favicon.png" rel="icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/atom.xml" rel="alternate" title="王中周的技术博客" type="application/atom+xml">
    <script src="/javascripts/modernizr-2.0.js"></script>

    <!-- googleapis is fucked by gfw -->
    <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
    <!--<script src="//libs.baidu.com/jquery/1.7.2/jquery.min.js"></script>-->
    <script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>

    <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
    <script src="/javascripts/octopress.js" type="text/javascript"></script>
    <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->

    <script type="text/javascript">

        function addBlankTargetForLinks() {

            $('a[href^="http"]').each(function () {

                $(this).attr('target', '_blank');

            });

        }

        $(document).bind('DOMNodeInserted', function (event) {

            addBlankTargetForLinks();

        });

    </script>


</head>

<body>
<header role="banner">
    <hgroup>
        <h1><a href="/">王中周的技术博客</a></h1>

        <h2>Stay hungry,stay foolish.</h2>

    </hgroup>

</header>
<nav role="navigation">
    <ul class="subscription" data-subscription="rss">
        <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>

    </ul>

    <form action="https://www.google.com/search" method="get">
        <fieldset role="search">
            <input type="hidden" name="q" value="site:foggry.com"/>
            <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
    </form>

    <ul class="main-navigation">
        <li><a href="/">Blog</a></li>
        <li><a href="/blog/archives">Archives</a></li>
        <li><a href="/about">About Me</a></li>
    </ul>

</nav>
<div id="main">
    <div id="content">
        <div>
            <article class="hentry" role="article">

                <header>

                    <h1 class="entry-title">Try Catch 原理剖析</h1>


                    <p class="meta">


                        <time datetime="2018-11-15T08:27:01+08:00" pubdate data-updated="true">Nov 15<span>th</span>,
                            2018
                        </time>

                        <!-- disqus -->


                        <!-- duoshuo -->


                        <!-- livere -->
                        <!--  -->


                    </p>

                </header>


                <div class="entry-content"><h2>一、非局部跳转</h2>

                    <h3>1、简介</h3>

                    <p>
                        大部分语言的运行控制模型，都是基于栈的。在这种模型中，调用一个函数时，就会将这个函数的参数、返回地址、局部变量等信息入栈；这个函数返回时，对应信息再出栈。正常情况下，函数调用的进栈和出栈都是成对出现的，比如函数的调用顺序是：func1
                        &mdash;> func2 &mdash; > func3，那么一定是 func1 先进栈，然后是 func2，最后是 func3；而 func3 调用结束后一定是先返回到 func2
                        ，然后从 func2 返回到func3，而不能直接从 func3 返回到 func1。</p>

                    <p>我们都知道，C 语言中的 goto 语句，可以实现在一个函数内部跳转;与此同时，C 语言还提供了一种能够在函数间跳转、被称为 <code>非局部跳转</code> (no-local goto)
                        的机制，这种机制可以允许从一个多层嵌套的函数调用中直接返回。我们先通过下面的栗子来见证它的神奇之处：</p>

                    <!-- more -->


                    <figure class='code'>
                        <div class="highlight">
                            <table>
                                <tr>
                                    <td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre>
                                    </td>
                                    <td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;setjmp.h&gt;
</span><span class='line'>
</span><span class='line'>jmp_buf jump_buffer;
</span><span class='line'>
</span><span class='line'>void func2(void)
</span><span class='line'>{
</span><span class='line'>printf("Before calling longjmp\n");
</span><span class='line'>longjmp(jump_buffer, 1);
</span><span class='line'>printf("After calling longjmp\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>void func1(void)
</span><span class='line'>{
</span><span class='line'>printf("Before calling func2\n");
</span><span class='line'>func2();
</span><span class='line'>printf("After calling func2\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main()
</span><span class='line'>{
</span><span class='line'>if (setjmp(jump_buffer) == 0){
</span><span class='line'>printf("first calling set_jmp\n");
</span><span class='line'>func1();
</span><span class='line'>} else {
</span><span class='line'>printf("second calling set_jmp\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>return 0;
</span><span class='line'>}
</span></code></pre>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </figure>


                    <p>运行结果如下：</p>

                    <figure class='code'>
                        <div class="highlight">
                            <table>
                                <tr>
                                    <td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre>
                                    </td>
                                    <td class='code'><pre><code class=''><span class='line'>first calling set_jmp
</span><span class='line'>Before calling func2
</span><span class='line'>Before calling longjmp
</span><span class='line'>second calling set_jmp</span></code></pre>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </figure>


                    <p>从日志可以看出，函数的执行过程跳过了 <code>After calling func2</code>、<code>After calling longjmp</code>
                        两句日志所在的代码行，在 <code>func2</code> 中执行了 <code>longjmp</code> 方法后函数直接从 <code>func2</code> 跳转回了
                        <code>main</code> 函数中继续执行，而没经过 <code>func1</code>！</p>

                    <h3>2、实现机制</h3>

                    <p>非局部跳转功能主要是通过位于 <code>&lt;setjmp.h&gt;</code> 中的 <code>setjmp</code> 和 <code>longjmp</code>
                        两个函数实现。</p>

                    <ul>
                        <li>setjmp</li>
                    </ul>


                    <figure class='code'>
                        <div class="highlight">
                            <table>
                                <tr>
                                    <td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre>
                                    </td>
                                    <td class='code'>
                                        <pre><code class=''><span class='line'>`int setjmp(jmp_buf env);`</span></code></pre>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </figure>


                    <p>可以把当前代码行的状态信息保存到 env 中，供以后 <code>longjmp</code> 恢复状态信息时使用。如果直接调用 <code>setjmp()</code>，则返回值为
                        0；如果是由于调用了 <code>longjmp</code> 而调用到 <code>setjmp</code>，则返回值为 <code>longjmp</code> 第二个参数所指定的值。
                    </p>

                    <ul>
                        <li>longjmp</li>
                    </ul>


                    <figure class='code'>
                        <div class="highlight">
                            <table>
                                <tr>
                                    <td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre>
                                    </td>
                                    <td class='code'>
                                        <pre><code class=''><span
                                                class='line'>`void longjmp(jmp_buf env, int val);`</span></code></pre>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </figure>


                    <p>用于将调用堆栈恢复成最近一次调用 <code>setjmp</code> 时所保存到 env 中的状态信息。也就是说，调用了 <code>longjmp</code>
                        后，不管当前调用堆栈在哪个方法中，都会回到有效范围内最近一次调用 <code>setjmp</code> 方法的地方，而 <code>setjmp</code> 方法的返回值就是这里设置的
                        <code>val</code> 的值，用于区分到底是从哪个 <code>longjmp</code> 返回到的 <code>setjmp</code>。</p>

                    <p>而 <code>jmp_buf</code> 是 <code>&lt;setjmp.h&gt;</code> 文件中定义的结构类型，用于保存系统状态信息。函数
                        <code>setjmp</code> 会将其所在的程序点的系统状态信息都保存到 <code>jmp_buf</code> 类型的结构变量 env 中，而调用
                        <code>longjmp</code> 会将 env 的系统状态信息恢复，以实现非局部跳转的功能。</p>

                    <h3>3、注意事项</h3>

                    <ul>
                        <li>执行顺序</li>
                    </ul>


                    <p><code>setjmp</code> 和 <code>longjmp</code> 结合使用时，必须要有严格的先后执行顺序，即先调用 <code>setjmp</code> 函数，再调用
                        <code>longjmp</code> 函数。否则如果在 <code>setjmp</code> 之前调用 <code>longjmp</code>，将导致程序的执行流变的不可预测，有可能导致程序崩溃。
                    </p>

                    <ul>
                        <li>作用域</li>
                    </ul>


                    <p><code>longjmp</code> 必须在正确的 <code>setjmp</code> 的作用域范围内。具体来说，在一个函数中调用了 <code>setjmp</code>，只要该函数没有返回，那么在任何其它地方都可以通过
                        <code>longjmp</code> 调用来跳转到 <code>setjmp</code> 的下一条语句执行。</p>

                    <h2>二、try/catch 异常处理机制</h2>

                    <p>在类 C 语言中，非局部跳转的一个重要应用场景就是 <code>异常处理机制</code>。Objective-C 使用 try/catch/finally 来捕获并处理异常，比如下面的代码：
                    </p>

                    <figure class='code'>
                        <div class="highlight">
                            <table>
                                <tr>
                                    <td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre>
                                    </td>
                                    <td class='code'><pre><code class=''><span class='line'>#import &lt;Foundation/Foundation.h&gt;
</span><span class='line'>
</span><span class='line'>int main (int argc, const char * argv[])
</span><span class='line'>{
</span><span class='line'>@autoreleasepool
</span><span class='line'>{
</span><span class='line'>@try {
</span><span class='line'>NSException *e = [NSException
</span><span class='line'>exceptionWithName:@"FileNotFoundException"
</span><span class='line'>reason:@"File Not Found on System"
</span><span class='line'>userInfo:nil];
</span><span class='line'>@throw e;
</span><span class='line'>}
</span><span class='line'>@catch (NSException *exception) {
</span><span class='line'>if ([[exception name] isEqualToString:NSInvalidArgumentException]) {
</span><span class='line'>NSLog(@"%@", exception);
</span><span class='line'>} else {
</span><span class='line'>@throw exception;
</span><span class='line'>}
</span><span class='line'>}
</span><span class='line'>@finally {
</span><span class='line'>NSLog(@"finally");
</span><span class='line'>}
</span><span class='line'>}
</span><span class='line'>return 0;
</span><span class='line'>}</span></code></pre>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </figure>


                    <p>通过 Clang 生成的 C 中间代码，可以看出 try/catch 的原理，上述代码保存成 main.m 文件后通过命令：</p>

                    <figure class='code'>
                        <div class="highlight">
                            <table>
                                <tr>
                                    <td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre>
                                    </td>
                                    <td class='code'>
                                        <pre><code class=''><span class='line'>clang -rewrite-objc main.m</span></code></pre>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </figure>


                    <p>剔除无用信息后，可以得到下述代码：</p>

                    <figure class='code'>
                        <div class="highlight">
                            <table>
                                <tr>
                                    <td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
</pre>
                                    </td>
                                    <td class='code'><pre><code class=''><span class='line'>#include &lt;Foundation/Foundation.h&gt;
</span><span class='line'>
</span><span class='line'>int main (int argc, const char * argv[])
</span><span class='line'>{
</span><span class='line'>@autoreleasepool
</span><span class='line'>{
</span><span class='line'>/**
</span><span class='line'>* try/catch的作用域从这里开始
</span><span class='line'>*/
</span><span class='line'>/* @try scope begin */
</span><span class='line'>{
</span><span class='line'>/**
</span><span class='line'>* 首先定义一个_objc_exception_data类型的结构体，用来保存异常现场的数据。
</span><span class='line'>*/
</span><span class='line'>struct _objc_exception_data
</span><span class='line'>{
</span><span class='line'>/**
</span><span class='line'>* buf变量就是c语言中的jmp_buf
</span><span class='line'>* jmp_buf的定义可在setjmp.h文件中找到：
</span><span class='line'>*
</span><span class='line'>*      #define _JBLEN        (10 + 16 + 2)
</span><span class='line'>*      #define _JBLEN_MAX    _JBLEN
</span><span class='line'>*
</span><span class='line'>*      typedef int jmp_buf[_JBLEN];
</span><span class='line'>*/
</span><span class='line'>int buf[18/*32-bit i386*/];
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* pointers[0]用来存储通过@throw抛出的异常对象，
</span><span class='line'>* pointers[1]存储下一个_stack数据。
</span><span class='line'>*/
</span><span class='line'>char *pointers[4];
</span><span class='line'>} _stack;
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* _rethrow保存可能在@catch中再次抛出的异常对象。
</span><span class='line'>*/
</span><span class='line'>id volatile _rethrow = 0;
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 因为异常处理支持嵌套，_stack会被存储在一个全局的栈中，这个栈用单链表的存储结构表示。
</span><span class='line'>* objc_exception_try_enter函数将_stack压栈。
</span><span class='line'>*/
</span><span class='line'>objc_exception_try_enter(&_stack);
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* _setjmp是C的函数，用于保存当前程序现场。
</span><span class='line'>* _setjmp需要传入一个jmp_buf参数，保存当前需要用到的寄存器的值。
</span><span class='line'>* _setjmp()它能返回两次，第一次是初始化时，返回0，第二次遇到_longjmp()函数调用会返回，返回值由_longjmp的第二个参数决定。
</span><span class='line'>* 如果对_setjmp()和_longjmp()概念不太了解的，请参考C语言的异常处理机制。
</span><span class='line'>*
</span><span class='line'>* 下面_setjmp()初始化返回0，然后执行if{}中也就是@try{}中的代码。
</span><span class='line'>*/
</span><span class='line'>if (!_setjmp(_stack.buf)) /* @try block continue */
</span><span class='line'>{
</span><span class='line'>/**
</span><span class='line'>* 创建一个NSException对象，对应代码：
</span><span class='line'>*
</span><span class='line'>*             NSException *e = [NSException
</span><span class='line'>*                               exceptionWithName:@"FileNotFoundException"
</span><span class='line'>*                               reason:@"File Not Found on System"
</span><span class='line'>*                               userInfo:nil];
</span><span class='line'>*/
</span><span class='line'>NSException *e = ((NSException *(*)(id, SEL, NSString *, NSString *, NSDictionary *))(void *)objc_msgSend)(objc_getClass("NSException"), sel_registerName("exceptionWithName:reason:userInfo:"), (NSString *)&__NSConstantStringImpl_main_m_0, (NSString *)&__NSConstantStringImpl_main_m_1, (NSDictionary *)((void *)0));
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 抛出异常对象，对应代码：@throw e;
</span><span class='line'>*
</span><span class='line'>* objc_exception_throw函数实现步骤如下：
</span><span class='line'>* 1. 把e对象保存到_stack-&gt;pointers[0]中使其在@catch{}中能被捕获。
</span><span class='line'>* 2. 将_stack从全局栈中弹出。
</span><span class='line'>* 3. 调用_longjmp()跳转到前面if语句中的_setjmp()位置。_longjmp()使得_setjmp()函数第二次返回，
</span><span class='line'>* 返回值为1，所以会执行else{}中也就是@catch{}中的代码。
</span><span class='line'>*/
</span><span class='line'>objc_exception_throw(e);
</span><span class='line'>
</span><span class='line'>} /* @catch begin */ else {
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* objc_exception_extract函数从_stack-&gt;pointers[0]中取得上面抛出的异常对象。
</span><span class='line'>*/
</span><span class='line'>id _caught = objc_exception_extract(&_stack);
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 这里为何再次调用objc_exception_try_enter对_stack压栈？先保留这个疑问，继续看下面的代码。
</span><span class='line'>*/
</span><span class='line'>objc_exception_try_enter (&_stack);
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 在@catch中设置一个跳转位置
</span><span class='line'>*/
</span><span class='line'>if (_setjmp(_stack.buf))
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 如果@catch{}中再次抛出异常，在这里捕获。
</span><span class='line'>*/
</span><span class='line'>_rethrow = objc_exception_extract(&_stack);
</span><span class='line'>
</span><span class='line'>else { /* @catch continue */
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* objc_exception_match函数判断_caught对象是否是需要捕获的目标对象。对应代码：
</span><span class='line'>*
</span><span class='line'>* @catch (NSException *exception) {
</span><span class='line'>*/
</span><span class='line'>if (objc_exception_match((struct objc_class *)objc_getClass("NSException"), (struct objc_object *)_caught)) {
</span><span class='line'>NSException *exception = _caught;
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 比较捕获的异常是不是NSInvalidArgumentException类型。对应代码：
</span><span class='line'>*
</span><span class='line'>* if ([[exception name] isEqualToString:NSInvalidArgumentException]) {
</span><span class='line'>*      NSLog(@"%@", exception);
</span><span class='line'>*
</span><span class='line'>*/
</span><span class='line'>if (((BOOL (*)(id, SEL, NSString *))(void *)objc_msgSend)((id)((NSString *(*)(id, SEL))(void *)objc_msgSend)((id)exception, sel_registerName("name")), sel_registerName("isEqualToString:"), (NSString *)NSInvalidArgumentException)) {
</span><span class='line'>
</span><span class='line'>NSLog((NSString *)&__NSConstantStringImpl_main_m_2, exception);
</span><span class='line'>} else {
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 抛出异常对象，然后跳转到前面@catch中的if语句中的_setjmp()位置。
</span><span class='line'>* 这就解释了前面为什么要在@catch中再次将_stack压栈和调用_setjmp()的原因。
</span><span class='line'>* 在当前@catch中，如果不设置一个跳转点来捕获@catch中抛出的异常，那么程序就直接跳转到全局栈的下一个@catch中，而下面的@finally{}代码就无法执行。
</span><span class='line'>* 在@catch中设置跳转点就是为了最后总能执行@finally中的代码。
</span><span class='line'>*/
</span><span class='line'>objc_exception_throw( exception);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>} /* last catch end */ else {
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* 如果异常对象没被处理，先将其保存到_rethrow变量。
</span><span class='line'>* objc_exception_try_exit函数将_stack从全局栈中弹出。
</span><span class='line'>*/
</span><span class='line'>_rethrow = _caught;
</span><span class='line'>objc_exception_try_exit(&_stack);
</span><span class='line'>}
</span><span class='line'>} /* @catch end */
</span><span class='line'>}
</span><span class='line'>/* @finally */
</span><span class='line'>{
</span><span class='line'>if (!_rethrow) objc_exception_try_exit(&_stack);
</span><span class='line'>
</span><span class='line'>NSLog((NSString *)&__NSConstantStringImpl_main_m_3);
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* _rethrow是前面@catch中没有被处理的或被捕获的异常对象，
</span><span class='line'>* 最后，_rethrow异常对象被抛到全局栈的下一个@catch中。
</span><span class='line'>*/
</span><span class='line'>if (_rethrow) objc_exception_throw(_rethrow);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>} /* @try scope end */
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>return 0;
</span><span class='line'>}</span></code></pre>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </figure>


                    <p>以上代码还涉及了 objc_exception_try_enter、 objc_exception_extract、 objc_exception_throw、
                        objc_exception_try_exit 等函数，都可以在苹果开源 <a
                                href="https://opensource.apple.com/source/objc4/">objc4</a> 的 objc-exception.mm 文件中找到。
                    </p>

                    <h2>参考文档</h2>

                    <ul>
                        <li><p><a href="https://www.cnblogs.com/lienhua34/archive/2012/04/22/2464859.html">浅析C语言的非局部跳转：setjmp和longjmp</a>
                        </p></li>
                        <li><p><a
                                href="https://blog.csdn.net/wykwdy007/article/details/6535322">setjmp和longjmp函数使用详解</a>
                        </p></li>
                        <li><p><a href="https://www.cnblogs.com/markhy/p/3169035.html">Objective-C try/catch异常处理机制原理</a>
                        </p></li>
                    </ul>

                </div>


                <footer>
                    <p class="meta">
                    <h2>赞助催更</h2>

                    <div style="text-align: center;">
                        <img src="/images/weixinpay.jpg" align="middle" height="200" width="200" alt="打赏"/>
                    </div>

                    <div style="text-align: center;">
                        <p>如果觉得文章对你有帮助，请我吃个鸡腿吧！</p>
                    </div>

                    <!-- <br/> -->
                    <h2></h2>


                    <span class="byline author vcard">Posted by <span class="fn">王中周</span></span>


                    <time datetime="2018-11-15T08:27:01+08:00" pubdate data-updated="true">Nov 15<span>th</span>, 2018
                    </time>


                    <span class="categories">

    <a class='category' href='/blog/categories/ios/'>iOS</a>

</span>


                    </p>

                    <div class="sharing">


                        <!-- JiaThis Button BEGIN -->
                        <div class="jiathis_style_32x32">
                            <a class="jiathis_button_qzone"></a>
                            <a class="jiathis_button_tsina"></a>
                            <a class="jiathis_button_tqq"></a>
                            <a class="jiathis_button_weixin"></a>
                            <a class="jiathis_button_renren"></a>
                            <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis"
                               target="_blank"></a>
                            <a class="jiathis_counter_style"></a>
                        </div>
                        <script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1394012284741689"
                                charset="utf-8"></script>
                        <!-- JiaThis Button END -->
                        <!-- UJian Button BEGIN -->
                        <div class="ujian-hook"></div>
                        <script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js"></script>
                        <!-- UJian Button END -->

                        <!-- UY BEGIN -->
                        <div id="uyan_frame"></div>
                        <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js"></script>
                        <!-- UY END -->

                    </div>


                    <p class="meta">

                        <a class="basic-alignment left" href="/blog/2017/02/13/iosnei-cun-tan-mi/"
                           title="Previous Post: iOS内存探秘">&laquo; iOS内存探秘</a>


                        <a class="basic-alignment right" href="/blog/2018/11/18/bian-chang-can-shu-xue-xi-bi-ji/"
                           title="Next Post: 变长参数学习笔记">变长参数学习笔记 &raquo;</a>

                    </p>
                </footer>
            </article>

            <!-- disqus -->
            <!--  -->

            <!-- duoshuo -->
            <!--  -->

            <!-- livere -->
            <!--  -->


        </div>

        <aside class="sidebar">

            <section>
                <h1>博主简介</h1>
                <li>
                    <p>
                        <span style="color:#222222;font-family:inherit;font-size:18px;font-style:inherit;font-weight:inherit;line-height:1.5;">曾就职于拉手网、高德地图；</span>
                    </p>
                    <p>
                        <span style="font-family:inherit;font-style:inherit;font-weight:inherit;color:#222222;font-size:18px;line-height:1.5;">早期在<a
                                href="http://blog.csdn.net/wzzvictory" target="_blank"><span style="color:#E53333;">CSND上写博客</span></a></span>
                    </p>
                </li>
            </section>
            <section>
                <h1>新浪微博</h1>
                <ul id="weibo">
                    <li>

                        <iframe width="100%" height="130" class="share_self" frameborder="0" scrolling="no"
                                src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=2&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1734555471&verifier=6c6f0bb3&dpc=1"></iframe>

                    </li>
                </ul>
            </section>
            <section>
                <h1>Recent Posts</h1>
                <ul id="recent_posts">

                    <li class="post">
                        <a href="/blog/2018/11/18/bian-chang-can-shu-xue-xi-bi-ji/">变长参数学习笔记</a>
                    </li>

                    <li class="post">
                        <a href="/blog/2018/11/15/try-catch-yuan-li-pou-xi/">Try Catch 原理剖析</a>
                    </li>

                    <li class="post">
                        <a href="/blog/2017/02/13/iosnei-cun-tan-mi/">iOS内存探秘</a>
                    </li>

                    <li class="post">
                        <a href="/blog/2017/02/06/wei-shi-yao-objective-c-dui-xiang-cun-chu-zai-dui-shang-er-bu-shi-zhan-shang/">为什么
                            Objective-C 对象存储在堆上而不是栈上</a>
                    </li>

                    <li class="post">
                        <a href="/blog/2016/03/23/cocoapods-xiang-jie-zhi-geng-xin-pian/">CocoaPods 详解之----更新篇</a>
                    </li>

                </ul>
            </section>
            <section>
                <h1>Categories</h1>
                <ul id="categories">
                    <li class='category'><a href='/blog/categories/c语言/'>C语言 (1)</a></li>
                    <li class='category'><a href='/blog/categories/database/'>Database (1)</a></li>
                    <li class='category'><a href='/blog/categories/octopress/'>Octopress (2)</a></li>
                    <li class='category'><a href='/blog/categories/wwdc2014/'>WWDC2014 (2)</a></li>
                    <li class='category'><a href='/blog/categories/xcode/'>Xcode (1)</a></li>
                    <li class='category'><a href='/blog/categories/xcodesettings/'>XcodeSettings (1)</a></li>
                    <li class='category'><a href='/blog/categories/ios/'>iOS (12)</a></li>
                    <li class='category'><a href='/blog/categories/opensource/'>opensource (1)</a></li>

                </ul>
            </section>
            <section>
                <!-- <h1>广告时间</h1> -->
                <h1>点我看看</h1>
                <ul id="ad">
                    <li>


                        <!-- 广告位：Google -->
                        <!--
                        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                        -->
                        <!-- 王中周的技术博客 -->
                        <!--
                        <ins class="adsbygoogle"
                             style="display:inline-block;width:250px;height:250px"
                             data-ad-client="ca-pub-4428888818448200"
                             data-ad-slot="1259477576"></ins>
                        <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                        -->

                        <!-- 广告位：Google -->
                        <!-- 王中周的技术博客 -->
                        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                        <script>
                            (adsbygoogle = window.adsbygoogle || []).push({
                                google_ad_client: "ca-pub-4625946986997917",
                                enable_page_level_ads: true
                            });
                        </script>


                        <!-- <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p> -->


                        <!-- 广告位：Baidu -->
                        <!-- 广告位：技术博客 -->
                        <!-- <script type="text/javascript" >BAIDU_CLB_SLOT_ID = "985176";</script>
                        <script type="text/javascript" src="http://cbjs.baidu.com/js/o.js"></script> -->


                    </li>
                </ul>
            </section>


        </aside>


    </div>
</div>
<footer role="contentinfo">
    <div style="text-align:center;">
        <span style="line-height:1.5;">This work is licensed under a </span><a
            href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons
        Attribution-NonCommercial-ShareAlike 4.0 International License</a><span style="line-height:1.5;">.</span>
    </div>
    <p style="text-align:center;">
        <span style="line-height:1;">Copyright &copy; 2018 - 王中周 - </span><span class="credit"><span
            style="line-height:1;">Powered by </span><a href="http://octopress.org"><span style="line-height:1;">Octopress</span></a></span>
        | <span style="line-height:1;">Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></span>
    </p>


    <p>
        <script type="text/javascript">
            var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
            document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F9975063b89c363c67eac651132751ee6' type='text/javascript'%3E%3C/script%3E"));
        </script>
    </p>
</footer>


<!--返回顶部开始-->
<div id="full"
     style="width:0px; height:0px; position:fixed; right:190px; bottom:150px; z-index:100; text-align:center; background-color:transparent; cursor:pointer;">
    <a href="#" onclick="goTop();return false;"><img src="/images/top.png" border=0 alt="返回顶部"></a>
</div>
<script src="/javascripts/top.js" type="text/javascript"></script>
<!--返回顶部结束-->
</body>
</html>
